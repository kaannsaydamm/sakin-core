{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://sakin.io/schemas/correlation-rule.json",
  "title": "Correlation Rule",
  "description": "Schema for correlation rule definitions",
  "type": "object",
  "required": ["id", "name", "severity", "triggers"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_-]+$",
      "minLength": 1,
      "maxLength": 100,
      "description": "Unique identifier for the rule"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 200,
      "description": "Human-readable name for the rule"
    },
    "description": {
      "type": "string",
      "maxLength": 1000,
      "description": "Detailed description of what the rule detects"
    },
    "enabled": {
      "type": "boolean",
      "default": true,
      "description": "Whether the rule is active"
    },
    "severity": {
      "type": "string",
      "enum": ["low", "medium", "high", "critical"],
      "description": "Severity level for alerts generated by this rule"
    },
    "triggers": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/trigger"
      },
      "description": "List of triggers that activate this rule"
    },
    "conditions": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/condition"
      },
      "description": "Conditions that must be met for the rule to trigger"
    },
    "aggregation": {
      "$ref": "#/definitions/aggregationWindow",
      "description": "Aggregation settings for the rule"
    },
    "actions": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/action"
      },
      "description": "Actions to execute when the rule triggers"
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata for the rule"
    }
  },
  "definitions": {
    "trigger": {
      "type": "object",
      "required": ["type", "eventType"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["event", "time", "threshold"]
        },
        "eventType": {
          "type": "string",
          "minLength": 1,
          "description": "Type of event that triggers the rule"
        },
        "source": {
          "type": "string",
          "description": "Source system or component"
        },
        "filters": {
          "type": "object",
          "description": "Additional filters for the trigger"
        }
      }
    },
    "condition": {
      "type": "object",
      "required": ["field", "operator"],
      "properties": {
        "field": {
          "type": "string",
          "minLength": 1,
          "description": "Field to evaluate the condition on"
        },
        "operator": {
          "type": "string",
          "enum": [
            "equals", "not_equals", "contains", "not_contains",
            "starts_with", "ends_with", "greater_than", "greater_than_or_equal",
            "less_than", "less_than_or_equal", "in", "not_in",
            "regex", "exists", "not_exists"
          ]
        },
        "value": {
          "description": "Value to compare against"
        },
        "caseSensitive": {
          "type": "boolean",
          "default": true
        },
        "negate": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "aggregationWindow": {
      "type": "object",
      "required": ["type", "size", "unit"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["time_window", "count", "sum", "average", "min", "max"]
        },
        "size": {
          "type": "integer",
          "minimum": 1,
          "description": "Size of the aggregation window"
        },
        "unit": {
          "type": "string",
          "enum": ["seconds", "minutes", "hours", "days"]
        },
        "groupBy": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Fields to group by during aggregation"
        },
        "having": {
          "$ref": "#/definitions/condition",
          "description": "Having clause for aggregation"
        }
      }
    },
    "action": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["alert", "webhook", "email", "script", "log", "block", "quarantine", "playbook"]
        },
        "parameters": {
          "type": "object",
          "description": "Parameters for the action"
        },
        "delay": {
          "type": "integer",
          "minimum": 0,
          "description": "Delay in milliseconds before executing the action"
        },
        "retry": {
          "$ref": "#/definitions/retryPolicy",
          "description": "Retry policy for failed actions"
        }
      }
    },
    "retryPolicy": {
      "type": "object",
      "properties": {
        "attempts": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 3
        },
        "delay": {
          "type": "integer",
          "minimum": 0,
          "default": 1000
        },
        "backoff": {
          "type": "string",
          "enum": ["fixed", "exponential", "linear"],
          "default": "fixed"
        }
      }
    }
  }
}